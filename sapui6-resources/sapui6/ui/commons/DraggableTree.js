jQuery.sap.declare("sapui6.ui.commons.DraggableTree"),jQuery.sap.require("sap.ui.commons.Tree"),sap.ui.commons.Tree.extend("sapui6.ui.commons.DraggableTree",{library:"sapui6.ui.commons",metadata:{properties:{draggable:{type:"boolean",defaultValue:!0},showContextmenu:{type:"boolean",defaultValue:!0}}},bFirstNodeRendered:!1,_checkedNodes:[],_dropContextMenu:null,_contextMenu:null,_dragId:"",_dropId:"",_dropNode:null,_selectNode:null,_copyNode:null,_copyTreeNode:null,renderer:function(e,t){var o=e;t.bFirstNodeRendered=!1,o.write("<div"),o.writeControlData(t),o.addClass("sapUiTree"),""!=t.getHeight()&&"auto"!=t.getHeight()&&o.addClass("sapUiTreeFixedHeight"),t.getShowHeader()||o.addClass("sapUiTreeTransparent"),o.writeClasses(),o.addStyle("width",t.getWidth()||"auto"),o.addStyle("height",t.getHeight()),o.addStyle("min-width",t.getMinWidth()),o.writeStyles(),o.writeAttribute("role","tree"),o.write(">"),t.getShowHeader()&&(o.write('<div id="'+t.getId()+'-Header" class="sapUiTreeHeader"'),o.writeAttribute("role","heading"),o.write(">"),o.write("<div class='sapUiTreeTitle'"),t.getTooltip_AsString()&&o.writeAttributeEscaped("title",t.getTooltip_AsString()),o.write(">"),o.writeEscaped(t.getTitle()),o.write("</div>"),t.getShowHeaderIcons()&&(o.write("<div id='"+t.getId()+"-TBCont' class='sapUiTreeTbCont'"),o.writeAttribute("role","toolbar"),o.write(">"),o.renderControl(t.oCollapseAllButton),o.renderControl(t.oExpandAllButton),o.write("</div>")),o.write("</div>")),o.write('<div id="'+t.getId()+'-TreeCont"'),o.addClass("sapUiTreeCont");var r=t.getShowHorizontalScrollbar();r?o.addClass("sapUiTreeContScroll"):o.addClass("sapUiTreeContNoScroll"),o.writeClasses(),o.write(">"),o.write('<ul class="sapUiTreeList">');for(var i=t.getNodes(),d=0;d<i.length;d++)t.renderNode(o,i[d],1,i.length,d+1);o.write("</ul>"),o.write("</div>"),o.write("</div>")}}),sapui6.ui.commons.DraggableTree.prototype.renderNode=function(e,t,o,r,i){var d,a=e;a.write("<li"),a.writeElementData(t),a.addClass("sapUiTreeNode"),t.getExpanded()&&(t.getHasExpander()||t.hasChildren())?(a.addClass("sapUiTreeNodeExpanded"),d=!0):t.getExpanded()||!t.getHasExpander()&&!t.hasChildren()||(a.addClass("sapUiTreeNodeCollapsed"),d=!1),t.getSelectable()&&t.getIsSelected()&&(a.addClass("sapUiTreeNodeSelected"),a.writeAttribute("aria-selected","true")),!d&&t.hasSelectedHiddenChild()&&(a.addClass("sapUiTreeNodeSelectedParent"),a.writeAttribute("aria-selected","true")),a.writeClasses(t);var n={role:"treeitem",level:o,setsize:r,posinset:i};if(d?n.expanded=!0:t.getHasExpander()&&(n.expanded=!1),a.writeAccessibilityState(t,n),a.writeAttributeEscaped("title",t.getTooltip_AsString()),this.bFirstNodeRendered||(a.write("tabindex='0'"),this.bFirstNodeRendered=!0),a.write(">"),a.write("<span"),a.addClass("sapUiTreeNodeContent"),t.getSelectable()||a.addClass("sapUiTreeNodeNotSelectable"),a.writeClasses(),this.getDraggable()&&this.isSupportDraggable()&&(a.addStyle("width","initial !important"),a.addStyle("display","inline"),a.writeStyles(),a.writeAttribute("draggable","true"),a.writeAttribute("ondragstart","sap.ui.getCore().byId('"+this.getId()+"').drag(event);"),a.writeAttribute("ondrop","sap.ui.getCore().byId('"+this.getId()+"').drop(event);"),a.writeAttribute("ondragover","sap.ui.getCore().byId('"+this.getId()+"').allowDrop(event);")),this.getShowContextmenu()&&a.writeAttribute("oncontextmenu","sap.ui.getCore().byId('"+this.getId()+"')._showContextMenu(event);return false;"),a.write(">"),t.getShowCheckBox()&&(t.getChecked()?a.write('<input type="checkbox" onclick="sap.ui.getCore().byId(\''+this.getId()+"')._checkNode(this,'"+t.getId()+"')\" checked>"):a.write('<input type="checkbox" onclick="sap.ui.getCore().byId(\''+this.getId()+"')._checkNode(this,'"+t.getId()+"')\">")),t.getIcon()&&a.writeIcon(t.getIcon(),"sapUiTreeIcon"),a.writeEscaped(t.getText()),a.write("</span>"),a.write("</li>"),t.getNodes()){var s=t.getNodes();a.write("<ul"),a.writeAttribute("id",t.getId()+"-children"),a.addClass("sapUiTreeChildrenNodes"),d?a.writeAttribute("style","display: block;"):a.addClass("sapUiTreeHiddenChildrenNodes"),a.writeClasses(),a.write(">"),o++;for(var u=0;u<s.length;u++)this.renderNode(a,s[u],o,s.length,u+1);a.write("</ul>")}},sapui6.ui.commons.DraggableTree.prototype._createDropContextMenu=function(){var e=this;jQuery.sap.require("sap.ui.unified.Menu"),this._dropContextMenu=new sap.ui.unified.Menu,this._dropContextMenu.addItem(new sap.ui.unified.MenuItem({text:"Move to above of current node",icon:"sap-icon://arrow-top",select:function(t){e._changeTree(e._dragId,e._dropId,"top"),$(e._dropNode).css("border",""),e._dropNode=null}})),this._dropContextMenu.addItem(new sap.ui.unified.MenuItem({text:"Move to below of current node",icon:"sap-icon://arrow-bottom",select:function(t){e._changeTree(e._dragId,e._dropId,"bottom"),$(e._dropNode).css("border",""),e._dropNode=null}})),this._dropContextMenu.addItem(new sap.ui.unified.MenuItem({text:"Move to sub of current node",icon:"sap-icon://open-command-field",select:function(t){e._changeTree(e._dragId,e._dropId,"child"),$(e._dropNode).css("border",""),e._dropNode=null}}))},sapui6.ui.commons.DraggableTree.prototype._createContextMenu=function(){var e=this;jQuery.sap.require("sap.ui.unified.Menu"),this._contextMenu=new sap.ui.unified.Menu,this._contextMenu.addItem(new sap.ui.unified.MenuItem({text:"Copy",icon:"sap-icon://value-help",select:function(t){e._copyTreeNode=sap.ui.getCore().byId($(e._selectNode).attr("id")).clone(),e._copyNode=e._selectNode,e._selectNode=null}})),this._contextMenu.addItem(new sap.ui.unified.MenuItem({text:"Cut",icon:"sap-icon://value-help",select:function(t){e._copyNode=e._selectNode,e._selectNode=null}}));var t=!0;null==e._copyTreeNode&&null==e._copyNode&&(t=!1),this._contextMenu.addItem(new sap.ui.unified.MenuItem({text:"Paste",icon:"sap-icon://duplicate",select:function(t){null!=e._copyTreeNode?e._resetTreeNode2(e._copyTreeNode,$(e._selectNode).attr("id"),"child"):e._resetTreeNode($(e._copyNode).attr("id"),$(e._selectNode).attr("id"),"child"),e._copyNode=null,e._selectNode=null,e._copyTreeNode=null},enabled:t})),this._contextMenu.addItem(new sap.ui.unified.MenuItem({text:"Delete current node",icon:"sap-icon://delete",select:function(t){e._removeTreeNode($(e._selectNode).attr("id")),e._selectNode=null}}));var o=!0;0==e.getCheckedNodes().length&&(o=!1),this._contextMenu.addItem(new sap.ui.unified.MenuItem({text:"Delete checked nodes",icon:"sap-icon://delete",select:function(t){for(var o=e.getCheckedNodes(),r=o.length,i=0;r>i;i++)e._removeTreeNode(o[i].getId())},enabled:o}))},sapui6.ui.commons.DraggableTree.prototype._showContextMenu=function(e){this._createContextMenu();for(var t=e.target,o=t;"LI"!=o.tagName;)o=o.parentNode;this._selectNode=o;var r=sap.ui.core.Popup.Dock;this._contextMenu.open(!1,t,r.BeginTop,r.EndCenter,t,"2px -10px")},sapui6.ui.commons.DraggableTree.prototype._showDropPosition=function(e){if(this._dragId!=this._dropId){null==this._dropContextMenu&&this._createDropContextMenu();var t=e.target;null!=this._dropNode&&$(this._dropNode).css("border",""),this._dropNode=t,$(t).css("border","1px solid red");var o=sap.ui.core.Popup.Dock;this._dropContextMenu.open(!1,t,o.BeginTop,o.EndCenter,t,"2px -10px")}},sapui6.ui.commons.DraggableTree.prototype._hideDropPosition=function(e){this._dropContextMenu.close()},sapui6.ui.commons.DraggableTree.prototype.drag=function(e){for(var t=e.target;"LI"!=t.tagName;)t=t.parentNode;e.dataTransfer.setData("text",t.getAttribute("id"))},sapui6.ui.commons.DraggableTree.prototype.drop=function(e){for(var t=e.target;"LI"!=t.tagName;)t=t.parentNode;e.preventDefault(),this._dragId=e.dataTransfer.getData("text"),this._dropId=t.getAttribute("id"),this._showDropPosition(e)},sapui6.ui.commons.DraggableTree.prototype.allowDrop=function(e){e.preventDefault()},sapui6.ui.commons.DraggableTree.prototype.isSupportDraggable=function(){return"draggable"in document.createElement("span")?!0:!1},sapui6.ui.commons.DraggableTree.prototype._changeTree=function(e,t,o){this._resetTreeNode(e,t,o)},sapui6.ui.commons.DraggableTree.prototype._resetTreeNode=function(e,t,o){var r=sap.ui.getCore().byId(e);this._changeTreeNode(r,t,o)},sapui6.ui.commons.DraggableTree.prototype._resetTreeNode2=function(e,t,o){this._changeTreeNode(e,t,o)},sapui6.ui.commons.DraggableTree.prototype._changeTreeNode=function(e,t,o){for(var r=e,i=function(e){for(var d=e.getNodes(),a=d.length,n=0;a>n;n++){if(d[n].getId()==t){"top"==o?e.insertNode(r,n):"bottom"==o?e.insertNode(r,n+1):"child"==o&&d[n].addNode(r);break}i(d[n])}},d=this.getNodes().length,a=0;d>a;a++){var n=this.getNodes()[a];if(n.getId()==t){"top"==o?this.insertNode(r,a):"bottom"==o?this.insertNode(r,a+1):"child"==o&&n.addNode(r);break}i(n)}},sapui6.ui.commons.DraggableTree.prototype._removeTreeNode=function(e){for(var t=function(o){for(var r=o.getNodes(),i=r.length,d=0;i>d;d++){if(r[d].getId()==e){o.removeNode(r[d]);break}t(r[d])}},o=this.getNodes().length,r=0;o>r;r++){var i=this.getNodes()[r];if(i.getId()!=e){t(i);break}this.removeNode(i)}},sapui6.ui.commons.DraggableTree.prototype._checkNode=function(e,t){e.checked?sap.ui.getCore().byId(t).setChecked(!0):sap.ui.getCore().byId(t).setChecked(!1)},sapui6.ui.commons.DraggableTree.prototype.getCheckedNodes=function(){this._checkedNodes=[];var e=this;return this.getNodes().forEach(function(t){t.getChecked()&&e._checkedNodes.push(t),e._getCheckedSubNodes(t)}),this._checkedNodes},sapui6.ui.commons.DraggableTree.prototype._getCheckedSubNodes=function(e){var t=this;e.getNodes().forEach(function(e){e.getChecked()&&t._checkedNodes.push(e),t._getCheckedSubNodes(e)})},sap.ui.commons.TreeNode.extend("sapui6.ui.commons.DraggableTreeNode",{metadata:{library:"sapui6.ui.commons",properties:{key:{type:"string",defaultValue:null},showCheckBox:{type:"boolean",defaultValue:!1},checked:{type:"boolean",defaultValue:!1}}}});